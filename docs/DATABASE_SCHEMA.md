# Database Schema Documentation: Multi-Tenant Bedrock

Twin-AI utilizes a hybrid storage model (SQLite/PostgreSQL) strictly governed by the **Tuber** and **Sentinel** protocols to ensure perfect data integrity and multi-tenant isolation.

## Multi-Tenant Isolation (Sentinel)

The schema enforces a "Hard Wall" between user profiles:
*   **Mandatory Profile ID**: All user-specific tables (`responses`, `patterns`, `entities`, `entity_attributes`, `workflows`, `questions`) contain a `profile_id` column.
*   **Unique Constraints**: Multi-column unique indexes (e.g., `(profile_id, dimension_id, aspect_id)` on `patterns`) enable safe, isolated `UPSERT` operations.
*   **Row Level Security (RLS)**: PostgreSQL policies prevent unauthorized cross-profile data access at the engine level.

## Core Tables (Tuber)

### `patterns` (The Memory)
Stores the synthesized preferences of the user.
*   `impact_score`: (Midas) The weighted value of this pattern ($Confidence \times Strength$).
*   `pattern_type`: Includes 'preference' and 'synergy_[dim]'.
*   `metadata`: Stores synergy alignment scores and connection details.

### `entities` & `entity_attributes` (The World)
Maps the user's external environment.
*   `entity_attributes`: Stores profile-specific feelings (trust, priority) toward entities, enabling RL training.

### `questions` (The Inquiry)
The adaptive question bank.
*   `profile_id`: (Optional) Allows for profile-specific questions generated by the RL system.
*   `question_type`: 'RL_VALIDATION' for twin-user alignment checks.

### `workflows` (The Action)
Tracks user projects and habits.
*   `profile_id`: Ensures multi-tenant isolation for project simulation.
*   `metadata`: Stores `progress`, `priority`, and `deadline_days` used by the RL reward engine.

## Views & Analytics (Bolt)

### `v_knowledge_graph`
Flattens complex relationships between patterns, aspects, and entities. This view is the primary source for the "Value Graphic" and provides a performant O(N) extraction path for frontend visualizations.

### `get_comprehensive_analytics` (RPC)
A unified, batched RPC that returns metrics, dimension breakdowns, weekly activity, and knowledge graph data in a single request. This minimizes network latency and ensures UI consistency.

## Implementation Standards
*   **Performance Indexes**: Composite indexes on `(profile_id, created_at)` and `(profile_id, impact_score)` optimize common dashboard queries.
*   **Atomic Updates**: RL state updates and pattern detection utilize `db.transaction` to ensure consistency during high-frequency writes.
